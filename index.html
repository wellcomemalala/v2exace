<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>นักซิ่ง</title>
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

   <style>
  /* สไตล์เดิมทั้งหมดของคุณ 100% */
  html { touch-action: manipulation; }
  body { font-family: Arial, sans-serif; background-color: #f4f4f4; font-size: 24px; text-align: center; padding: 10px; }
  h1, h2 { color: #333; font-size: 32px; }
  #categorySection { margin: 20px 0; }
  #categoryButtons { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; max-width: 1000px; margin: 0 auto; }
  .category-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 20px 15px; text-align: center; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s ease; touch-action: manipulation; }
  .category-button.active { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 0 0 3px rgba(245, 87, 108, 0.3); }
  #backToCategoryBtn { background-color: #95a5a6; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 15px; display: none; touch-action: manipulation; }
  #menuSection { display: none; margin: 20px 0; }
  .menu-category-title { font-size: 28px; color: #2c3e50; margin-bottom: 15px; font-weight: bold; }
  #menuButtons { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; max-width: 1200px; margin: 0 auto; }
  #tableButtons { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px; }
  textarea, .comment-input-queue { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 10px; font-size: 18px; box-sizing: border-box; }
  .order-button, .table-button, .save-comment-button { background-color: #4CAF50; border: none; color: white; padding: 12px 20px; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 8px; width: 100%; box-sizing: border-box; touch-action: manipulation; }
  .table-button { background-color: #008CBA; }
  .move-button { background-color: #f39c12; }
  .reservation-button { background-color: #e74c3c; color: white; font-weight: bold; border: 2px solid #c0392b; }
  .stock-button { background-color: #555; color: white; border: 2px solid #333; }
  .sold-out { background-color: #7f8c8d !important; opacity: 0.6; text-decoration: line-through; color: #bdc3c7 !important; position: relative; }
  .undo-button { background-color: #f1c40f; color: black; font-weight: bold; }
  .complete-button { background-color: #8e44ad; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #dddddd; text-align: left; padding: 10px; vertical-align: middle; }
  #tableOrdersTable th, #tableOrdersTable td { text-align: center; }
  th { background-color: #f2f2f2; }
  .wait-normal { background-color: white; }
  .wait-medium { background-color: #fff3cd; }
  .wait-long { background-color: #f8d7da; }
  #syncStatusBar { position: fixed; top: 0; left: 0; right: 0; height: 30px; background: linear-gradient(to right, #4CAF50, #45a049); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 1001; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  /* เพิ่มตรงนี้ */
#syncStatusBar.offline {
    background: linear-gradient(to right, #e74c3c, #c0392b); /* สีแดง */
}
  #selectedItemsDisplay { background-color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .comment-input-selected { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
  .category-blue { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important; color: white !important; }
  .category-yellow { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%) !important; color: #333 !important; }
  #kitchenDisplay { margin: 30px 0; padding: 15px; background-color: #f9f9f9; border-radius: 10px; }
  .kitchen-sections { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
  .chef-section { background-color: white; padding: 12px; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
  .chef-orders { min-height: 40px; font-size: 16px; line-height: 1.4; }
  
  
  #oldTableName, #newTableName {
    font-size: 26px;      /* ขนาดตัวอักษรใหญ่ขึ้น */
    padding: 12px;        /* เพิ่มความหนาของช่องกรอก */
    margin: 10px;         /* เว้นระยะห่างระหว่างช่อง */
    width: 220px;         /* ความกว้างของช่อง */
    border: 2px solid #008CBA; /* เส้นขอบหนาขึ้นและมีสีน้ำเงิน */
    border-radius: 8px;   /* ขอบมน */
    box-sizing: border-box;
  }

  /* ปรับปุ่มย้ายโต๊ะให้ใหญ่สมดุลกับช่องกรอก */
  .move-button {
    font-size: 22px !important;
    padding: 12px 30px !important;
    width: auto !important;
    margin-left: 10px;
  }
  
  
  
</style>
</head>
<body>

<div id="syncStatusBar">
  <span id="syncStatusText">เชื่อมต่อแล้ว</span>
</div>

<div style="margin-top: 35px; margin-bottom: 15px; text-align: right;">
    <button id="stockModeBtn" class="order-button stock-button" onclick="toggleStockMode()" style="width: auto; padding: 10px 20px;">จัดการของหมด (ปิด)</button>
</div>

<div id="categorySection">
  <h2>เลือกหมวดหมู่</h2>
  <div id="categoryButtons"></div>
</div>

<div id="menuSection">
  <button id="backToCategoryBtn" onclick="backToCategory()">← กลับไปเลือกหมวดหมู่</button>
  <h2 class="menu-category-title" id="currentCategoryName"></h2>
  <div id="menuButtons"></div>
</div>

<div id="selectedItemsDisplay">
  <h2>อาหารที่เลือกไว้</h2>
  <table id="selectedItemsTable">
    <thead>
      <tr><th>รายการ</th><th>จำนวน</th><th>เพิ่ม/ลด</th><th>คอมเมนต์</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="tableButtons"></div>

<h2>เปลี่ยนชื่อโต๊ะ</h2>
<input type="text" id="oldTableName" placeholder="โต๊ะเดิม">
<input type="text" id="newTableName" placeholder="โต๊ะใหม่">
<button class="order-button move-button" onclick="changeTableName()">ย้ายโต๊ะ</button>

<div id="tableOrders">
  <h2>คิว</h2>
  <table id="tableOrdersTable">
    <thead>
      <tr><th>โต๊ะ</th><th>เมนู</th><th>จำนวน</th><th>คอมเมนต์</th><th>รอ</th><th>สถานะ</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="kitchenDisplay">
  <h2>ครัว</h2>
  <div class="kitchen-sections">
    <div class="chef-section"><h3>กิ๊ก</h3><div class="chef-orders" id="chef-kik"></div></div>
    <div class="chef-section"><h3>เจี๊ยบ</h3><div class="chef-orders" id="chef-jeab"></div></div>
    <div class="chef-section"><h3>พลโท</h3><div class="chef-orders" id="chef-nan"></div></div>
    <div class="chef-section"><h3>ซี</h3><div class="chef-orders" id="chef-see"></div></div>
  </div>
</div>

<div id="totalOrders"></div>
<div id="completedOrders"></div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; padding: 10px;">
  <button class="order-button" style="background-color: #e74c3c;" onclick="clearCompletedOrders()">ล้างรายการที่เสร็จแล้ว</button>
  <button class="order-button undo-button" onclick="undoLastComplete()">เรียกคืนรายการล่าสุด</button>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDskwJlUNbr3zkKnyY_-n582PdoCrts2AE",
    authDomain: "supertest01-55ac2.firebaseapp.com",
    databaseURL: "https://supertest01-55ac2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "supertest01-55ac2",
    storageBucket: "supertest01-55ac2.firebasestorage.app",
    messagingSenderId: "846236839338",
    appId: "1:846236839338:web:260ca9b6af72c69837cfd3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const BASE_PATH = "racing_order_app/";

let deviceId = localStorage.getItem('kaki_dev_id') || 'dev_' + Math.random().toString(36).substr(2, 9);
localStorage.setItem('kaki_dev_id', deviceId);

const chefMenus={'kik':['ต้มแซ่บ','คั่ว','ผักหวาน','แป๊ะซะ','แวะถัวะ','ผัดเผ็ด','อ่อม','แกงป่าผัก','แกงป่าหน่อไม้ดอง','แกงป่าหน่อไม้สด','บอน','มะรุม','กระบุก','แกงไก่หน่อ','แกงหมูหน่อ','แกงเนื้อหน่อ','แกงปลา','ผัดฉ่า','ปลาร้า','ไก่น้ำปลา','สามชั้น','หมูน้ำปลา','โสม','ผักหวานเห็ดเผาะ','ผักหวานไข่มดแดงใส่เห็ดเผาะ'],'jeab':['ไข่เจียว','แกงหอย','พิเศษ','ทอง','แถม','หมกหม้อ','ขี้เหล็ก','ต้มจืด','ทอดมัน','หมกปลานิล','ไก่หลงทาง'],'nan':['ขาหมู','ข้าว','ขนม','นึ่ง'],'see':['ลาบ','ปลาเนื้ออ่อน','ปลานิลแดดเดียว','สมุนไพร','สะเดาน้ำปลาหวาน','ตำ']};
const nonBatchableMenuItems=['ปลาช่อนแป๊ะซะ','ปลาช่อนแวะถัวะ','อ่อมหมู','ผักหวานไข่มดแดง','ผักหวาน','ผักหวานเห็ดเผาะ','ผักหวานไข่มดแดงใส่เห็ดเผาะ','ไข่เจียวบาว','ไข่เจียวธรรมดา','ไข่เจียวหมูสับ','ไข่เจียวไข่มดแดง'];

const menuCategories = {
'ของทอด': ['ปลาเนื้ออ่อน', 'ปลานิลแดดเดียว', 'หมูทอดสมุนไพร', 'สะเดาน้ำปลาหวาน'],
  
  'คั่ว': ['คั่วไก่', 'คั่วกบ', 'คั่วเนื้อ', 'คั่วหมู', 'คั่วปลาไหล', 'คั่วเครื่องใน'],
  
  'ต้มแซ่บ': ['ต้มแซ่บไก่', 'ต้มแซ่บเนื้อ', 'ต้มแซ่บหมู', 'ต้มแซ่บกระดูกอ่อน', 'ต้มแซ่บเครื่องใน'],
  
  'ปลาช่อน': ['ปลาช่อนแป๊ะซะ', 'ปลาช่อนแวะถัวะ'],
  
  'ปลานึ่ง': ['ปลาช่อน นึ่ง', 'ปลานิล นึ่ง', 'ปลาทับทิม นึ่ง'],
  
  'ผัดเผ็ด': ['ผัดเผ็ดหมูป่า', 'ผัดเผ็ดกระดูกหมู', 'ผัดเผ็ดเครื่องใน', 'ผัดเผ็ดนกหน่อไม้', 'ผัดเผ็ดนกใบยี่หร่า'],
  
  'ลาบ': ['ลาบเป็ด', 'ลาบปลา', 'ลาบปู'],
  
  'อ่อม': ['อ่อมไก่', 'อ่อมกบ', 'อ่อมหมู', 'อ่อมเนื้อ', 'อ่อมหอย', 'อ่อมเครื่องใน', 'อ่อมนก'],
  
  'แกงป่าผัก': ['แกงป่าผักไก่', 'แกงป่าผักหมู', 'แกงป่าผักเนื้อ', 'แกงป่าผักปลา', 'แกงป่าผักเครื่องใน', 'แกงป่าผักนก'],
  
  'แกงป่าหน่อไม้ดอง': ['แกงป่าหน่อไม้ดองไก่', 'แกงป่าหน่อไม้ดองหมู', 'แกงป่าหน่อไม้ดองเนื้อ', 'แสงโสม', 'แกงป่าหน่อไม้ดองเครื่องใน', 'แกงป่าหน่อไม้ดองนก'],
  
  'แกงป่าหน่อไม้สด': ['แกงป่าหน่อไม้สดไก่', 'แกงป่าหน่อไม้สดหมู', 'แกงป่าหน่อไม้สดเนื้อ', 'แกงป่าหน่อไม้สดปลา', 'แกงป่าหน่อไม้สดเครื่องใน', 'แกงป่าหน่อไม้สดนก'],
  
  'ไข่เจียว': ['ไข่เจียวบาว', 'ไข่เจียวหมูสับ', 'ไข่เจียวธรรมดา', 'ไข่เจียวไข่มดแดง'],
  
  'แกงหน่อไม้ดอง': ['แกงไก่หน่อ', 'แกงหมูหน่อ', 'แกงเนื้อหน่อ'],
  
  'แกงปลาหน่อไม้ดอง': ['แกงปลากดหน่อ', 'แกงปลาหลดหน่อ', 'แกงปลานิลหน่อ', 'แกงปลาเนื้ออ่อนหน่อ'],
  
  'แกง': ['แกงบอน', 'มะรุม', 'กระบุก', 'แกงหอย'],
  
  'ผักหวาน': ['ผักหวาน', 'ผักหวานไข่มดแดง', 'ผักหวานเห็ดเผาะ', 'ผักหวานไข่มดแดงใส่เห็ดเผาะ'],
  
  'อื่นๆ': ['ขาหมู', 'ผัดฉ่าขาหมู', 'หมูปลาร้า', 'หมูน้ำปลา', 'ไก่ปลาร้า', 'ไก่น้ำปลา', 'ข้าว', 'ขนม', 'หงษ์ทอง', 'สามชั้นใบยี่หร่า', 'เมนูพิเศษ', 'ของแถม'],
  
  'เมนูพิเศษ': ['หมกหม้อ', 'ขี้เหล็ก', 'ต้มจืด', 'ทอดมัน', 'หมกปลานิล', 'ไก่หลงทาง'],
  
  'ส้มตำ': ['ตำลาว', 'ตำปูปลาล้าปูนิ่ง', 'ตำปูปลาล้าปูดอง', 'ตำแตง', 'ตำถั่ว', 'ตำไทย', 'ตำโคราช', 'ตำซั่ว', 'ตำป่า', 'ตำหมูยอ', 'ตำมาม่า', 'ตำไทยไข่เค็ม', 'ตำโพดไข่เค็ม', 'ตำกุ้งสด', 'ตำกุ้งสุกกกก', 'ตำทะเล']


};

let orderCounts = {}, menuComments = {}, selectionOrder = [];
let orders = [], completedOrders = [], totalOrders = {}, soldOutMap = {};
let isStockMode = false;

function createCategoryButtons() {
    const container = document.getElementById('categoryButtons');
    container.innerHTML = '';
    for (const cat in menuCategories) {
        const btn = document.createElement('button');
        btn.className = 'category-button';
        // --- แก้ไขจุดที่ 1: เพิ่มแกงปลาหน่อไม้ดองให้เป็นสีเหลือง ---
        if (['แกงป่าผัก', 'แกงป่าหน่อไม้ดอง', 'แกงป่าหน่อไม้สด'].includes(cat)) {
            btn.classList.add('category-blue');
        } else if (['แกงหน่อไม้ดอง', 'แกงปลาหน่อไม้ดอง'].includes(cat)) {
            btn.classList.add('category-yellow');
        }
        btn.textContent = cat;
        btn.onclick = () => showMenuItems(cat);
        container.appendChild(btn);
    }
}

function showMenuItems(cat) {
    document.getElementById('categorySection').style.display = 'none';
    document.getElementById('menuSection').style.display = 'block';
    document.getElementById('backToCategoryBtn').style.display = 'inline-block';
    document.getElementById('currentCategoryName').textContent = cat;
    const container = document.getElementById('menuButtons'); container.innerHTML = '';
    menuCategories[cat].forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'order-button';
        btn.innerHTML = `${item} <span id="quantity${item}">${orderCounts[item] || 0}</span>`;
        btn.onclick = () => placeOrder(item);
        if (soldOutMap[item]) btn.classList.add('sold-out');
        container.appendChild(btn);
    });
}

function backToCategory() {
    document.getElementById('categorySection').style.display = 'block';
    document.getElementById('menuSection').style.display = 'none';
}

function saveTemporaryData() {
    db.ref(BASE_PATH + 'tempData/' + deviceId).set({ orderCounts, comments: menuComments, selectionOrder });
}

function placeOrder(p) {
    if (isStockMode) {
        db.ref(BASE_PATH + 'soldOutItems/' + p).set(!soldOutMap[p]);
        return;
    }
    if (soldOutMap[p]) return;
    orderCounts[p] = (orderCounts[p] || 0) + 1;
    if (!selectionOrder.includes(p)) selectionOrder.push(p);
    saveTemporaryData();
}

function showSelectedItems() {
    const tbody = document.querySelector('#selectedItemsTable tbody');
    if (document.activeElement && document.activeElement.classList.contains('comment-input-selected')) return;
    tbody.innerHTML = '';
    selectionOrder.forEach(i => {
        if (orderCounts[i] > 0) {
            const r = tbody.insertRow();
            r.insertCell().textContent = i; r.insertCell().textContent = orderCounts[i];
            const a = r.insertCell();
            a.innerHTML = `<button class="order-button" style="width:40px; background:#e74c3c;" onclick="decrementOrderCount('${i}')">-</button>
                           <button class="order-button" style="width:40px; background:#2ecc71;" onclick="incrementOrderCount('${i}')">+</button>`;
            const cCell = r.insertCell();
            const input = document.createElement('input');
            input.className = 'comment-input-selected'; input.value = menuComments[i] || '';
            input.oninput = (e) => { 
                menuComments[i] = e.target.value; 
                db.ref(BASE_PATH + 'tempData/' + deviceId + '/comments/' + i).set(e.target.value);
            };
            cCell.appendChild(input);
        }
    });
}

function incrementOrderCount(i) { orderCounts[i]++; saveTemporaryData(); }
function decrementOrderCount(i) { 
    if(orderCounts[i]>0) orderCounts[i]--; 
    if(orderCounts[i]===0) selectionOrder = selectionOrder.filter(x => x !== i);
    saveTemporaryData(); 
}

function saveTable(t, isRes = false) {
    const timestamp = isRes ? new Date(Date.now() - 86400000).toISOString() : new Date().toISOString();
    selectionOrder.forEach(i => {
        if (orderCounts[i] > 0) {
            db.ref(BASE_PATH + 'orders').push({
                table: t, item: i, quantity: orderCounts[i], comment: (menuComments[i] || '').trim(), timestamp: timestamp
            });
            totalOrders[i] = (totalOrders[i] || 0) + orderCounts[i];
        }
    });
    db.ref(BASE_PATH + 'totalOrders').set(totalOrders);
    db.ref(BASE_PATH + 'tempData/' + deviceId).remove();
}

function handleComplete(orderId) {
    const o = orders.find(x => x.id === orderId);
    if (!o) return;
    if (o.quantity > 1) {
        db.ref(BASE_PATH + 'completedOrders').push({ ...o, quantity: 1, completedAt: new Date().toISOString() });
        db.ref(BASE_PATH + 'orders/' + orderId + '/quantity').set(o.quantity - 1);
        if (totalOrders[o.item]) totalOrders[o.item] = Math.max(0, totalOrders[o.item] - 1);
    } else {
        db.ref(BASE_PATH + 'completedOrders').push({ ...o, completedAt: new Date().toISOString() });
        if (totalOrders[o.item]) totalOrders[o.item] = Math.max(0, totalOrders[o.item] - 1);
        db.ref(BASE_PATH + 'orders/' + orderId).remove();
    }
    db.ref(BASE_PATH + 'totalOrders').set(totalOrders);
}

function undoLastComplete() {
    db.ref(BASE_PATH + 'completedOrders').limitToLast(1).once('value', snap => {
        if (!snap.exists()) return;
        const id = Object.keys(snap.val())[0];
        const data = snap.val()[id];
        delete data.completedAt; delete data.id;
        db.ref(BASE_PATH + 'orders').push(data);
        totalOrders[data.item] = (totalOrders[data.item] || 0) + data.quantity;
        db.ref(BASE_PATH + 'totalOrders').set(totalOrders);
        db.ref(BASE_PATH + 'completedOrders/' + id).remove();
    });
}

function showTableOrders() {
    const tbody = document.querySelector('#tableOrdersTable tbody');
    tbody.innerHTML = '';
    const sorted = [...orders].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    sorted.forEach(o => {
        const r = tbody.insertRow();
        const mins = Math.floor((new Date() - new Date(o.timestamp)) / 60000);
        
        // --- ส่วนที่เพิ่มใหม่: เช็คสถานะอาหารเสร็จ ---
        const isReady = o.status === 'ready';
        if (isReady) {
            r.style.backgroundColor = '#d4edda'; // สีเขียวอ่อน
            r.style.fontWeight = 'bold';
        } else if (mins >= 10) {
            r.className = 'wait-long';
        } else if (mins >= 5) {
            r.className = 'wait-medium';
        }
        // --------------------------------------

        r.insertCell().textContent = 'โต๊ะ ' + o.table;
        
        // ใส่ชื่อเมนู (ถ้าเสร็จแล้วให้ขีดฆ่า)
        const itemCell = r.insertCell();
        if (isReady) {
           itemCell.innerHTML = `<span style="color: #155724; font-weight: bold;">✅ ${o.item} (เสร็จแล้ว!)</span>`;
        } else {
            itemCell.textContent = o.item;
        }

        r.insertCell().textContent = o.quantity;
        
        const cCell = r.insertCell();
        cCell.innerHTML = `<input value="${o.comment || ''}" onchange="db.ref('${BASE_PATH}orders/${o.id}/comment').set(this.value)" style="width:70px">`;
        
        r.insertCell().textContent = mins + ' นาที';
        
        const btn = document.createElement('button');
        btn.className = 'order-button complete-button'; 
        btn.textContent = isReady ? 'พร้อมส่ง' : 'ส่ง';
        // ถ้าเสร็จแล้วให้ปุ่มสีเข้มขึ้น
        if (isReady) btn.style.backgroundColor = '#28a745';
        
        btn.onclick = () => handleComplete(o.id);
        r.insertCell().appendChild(btn);
    });
}

// ค้นหาฟังก์ชัน showTotalOrders ในไฟล์ index.html แล้วนำโค้ดนี้ไปทับครับ
function showTotalOrders() {
    const t = document.getElementById('totalOrders'); t.innerHTML = '<h2>เมนูซ้ำ</h2>';
    const b = {};
    
    // 1. จัดกลุ่ม และเก็บเวลาที่เก่าที่สุดของกลุ่มนั้นไว้
    orders.forEach(o => {
        const k = nonBatchableMenuItems.includes(o.item) ? `${o.item}-${o.timestamp}` : `${o.item}-${o.comment}`;
        if (!b[k]) b[k] = { item: o.item, comment: o.comment, reg: 0, th: 0, minTs: o.timestamp };
        
        // เก็บเวลาที่น้อยที่สุด (เก่าที่สุด) เพื่อใช้เรียงลำดับ
        if (new Date(o.timestamp) < new Date(b[k].minTs)) b[k].minTs = o.timestamp;
        
        /[ก-๙]/.test(o.table) ? b[k].th += o.quantity : b[k].reg += o.quantity;
    });

    // 2. แปลงเป็น Array แล้วเรียงลำดับตาม minTs (ใครเวลาเก่ากว่า/แซงคิว อยู่บน)
    const sortedGroups = Object.values(b).sort((x, y) => new Date(x.minTs) - new Date(y.minTs));

    // 3. แสดงผล
    sortedGroups.forEach(i => {
        const C = i.comment ? ` (${i.comment})` : '';
        let d = `${i.th + i.reg},${i.item}${C} ${i.reg}${i.th > 0 ? ', ก '+i.th : ''}`;
        const p = document.createElement('p'); p.textContent = d; t.appendChild(p);
    });
    updateKitchenDisplay();
}

function updateKitchenDisplay() {
    ['kik', 'jeab', 'nan', 'see'].forEach(c => document.getElementById(`chef-${c}`).innerHTML = '');
    document.querySelectorAll('#totalOrders p').forEach(p => {
        for (const [c, menus] of Object.entries(chefMenus)) {
            if (menus.some(m => p.textContent.includes(m))) {
                document.getElementById(`chef-${c}`).innerHTML += `<div>${p.textContent}</div>`;
                break;
            }
        }
    });
}

function changeTableName(){
    const o=document.getElementById('oldTableName').value.trim(), n=document.getElementById('newTableName').value.trim();
    if(o&&n){
        orders.forEach(d => { if(d.table === o) db.ref(BASE_PATH + 'orders/' + d.id + '/table').set(n); });
        document.getElementById('oldTableName').value=''; document.getElementById('newTableName').value='';
    }
}

function showCompletedOrders() {
    const e = document.getElementById('completedOrders'); e.innerHTML = '<h2>เสร็จแล้ว</h2>';
    completedOrders.slice().reverse().slice(0, 15).forEach(o => {
        e.innerHTML += `<p>โต๊ะ ${o.table}: ${o.item} ${o.comment ? '('+o.comment+')' : ''}</p>`;
    });
}

function toggleStockMode() {
    isStockMode = !isStockMode;
    const btn = document.getElementById('stockModeBtn');
    btn.textContent = isStockMode ? "จัดการของหมด (เปิด)" : "จัดการของหมด (ปิด)";
    btn.className = isStockMode ? "order-button stock-button stock-mode-active" : "order-button stock-button";
}

function clearCompletedOrders() { if(confirm('ล้างรายการที่เสร็จแล้ว?')) db.ref(BASE_PATH + 'completedOrders').remove(); }

window.addEventListener('load', () => {
    initTables();
    createCategoryButtons();
    db.ref(BASE_PATH + 'orders').on('value', snap => {
        const val = snap.val();
        orders = val ? Object.entries(val).map(([id, data]) => ({ id, ...data })) : [];
        showTableOrders(); showTotalOrders();
    });
    db.ref(BASE_PATH + 'completedOrders').on('value', snap => {
        const val = snap.val();
        completedOrders = val ? Object.values(val) : [];
        showCompletedOrders();
    });
    db.ref(BASE_PATH + 'totalOrders').on('value', snap => { totalOrders = snap.val() || {}; });
    db.ref(BASE_PATH + 'soldOutItems').on('value', snap => {
        soldOutMap = snap.val() || {};
        document.querySelectorAll('.order-button').forEach(btn => {
            const itemName = btn.innerText.split(' ')[0];
            if (soldOutMap[itemName]) btn.classList.add('sold-out'); else btn.classList.remove('sold-out');
        });
    });
    db.ref(BASE_PATH + 'tempData/' + deviceId).on('value', snap => {
        const d = snap.val() || {};
        // --- แก้ไขจุดที่ 2: ล้างตัวเลขบนปุ่มทิ้งเมื่อไม่มีข้อมูลในตะกร้า ---
        if (!snap.exists()) {
            orderCounts = {}; menuComments = {}; selectionOrder = [];
            // สั่ง Reset ตัวเลขบนปุ่มเมนูทั้งหมดให้เป็น 0
            document.querySelectorAll('[id^="quantity"]').forEach(span => span.innerText = '0');
        } else {
            orderCounts = d.orderCounts || {}; menuComments = d.comments || {}; selectionOrder = d.selectionOrder || [];
            // อัปเดตตัวเลขตามข้อมูลปัจจุบัน
            for(let i in orderCounts) {
                const el = document.getElementById('quantity' + i);
                if(el) el.innerText = orderCounts[i];
            }
        }
        showSelectedItems();
    });
    db.ref(".info/connected").on("value", snap => {
    const statusBar = document.getElementById('syncStatusBar');
    const statusText = document.getElementById('syncStatusText');
    
    if (snap.val()) {
        // ออนไลน์ - สีเขียว
        statusText.textContent = "ออนไลน์ (ID: " + deviceId + ")";
        statusBar.classList.remove('offline'); // ลบคลาส offline
    } else {
        // ออฟไลน์ - สีแดง
        statusText.textContent = "ออฟไลน์";
        statusBar.classList.add('offline'); // เพิ่มคลาส offline
    }
});
    setInterval(showTableOrders, 30000);
});

function initTables() {
    const container = document.getElementById('tableButtons');
    const resBtn = document.createElement('button');
    resBtn.className = 'table-button reservation-button'; resBtn.textContent = 'โต๊ะจอง';
    resBtn.onclick = () => { let t = prompt("ชื่อโต๊ะจอง:"); if(t) saveTable(t, true); };
    container.appendChild(resBtn);
    for (let i = 1; i <= 25; i++) {
        const btn = document.createElement('button');
        btn.className = 'table-button'; btn.textContent = 'โต๊ะ ' + i;
        btn.onclick = () => saveTable(i.toString());
        container.appendChild(btn);
    }
}
</script>
</body>
</html>